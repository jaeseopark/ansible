---
- name: Manage shell aliases across profiles
  block:
    - name: Create script directory
      file:
        path: "{{ script_dir }}"
        state: directory
        mode: '0755'
      tags: shell_aliases

    - name: Copy shell script files
      copy:
        src: "{{ item }}"
        dest: "{{ script_dir }}/{{ item }}"
        mode: '0755'
      loop:
        # TODO: find a way to iterate automatically (not urgent)
        - m4a.sh
        - gdl.sh
      tags: shell_aliases

    - name: Create shell profile files if they don't exist
      file:
        path: "{{ item }}"
        state: touch
        mode: '0644'
      loop: "{{ shell_profiles }}"
      tags: shell_aliases

    - name: Remove existing alias blocks from shell profiles
      replace:
        path: "{{ item }}"
        # Remove optional preceding newline(s), the managed block, and any trailing newlines.
        regexp: '(?:\r?\n)?{{ block_start_const | regex_escape }}[\s\S]*?{{ block_end_const | regex_escape }}\r?\n*'
        replace: ''
      loop: "{{ shell_profiles }}"
      tags: shell_aliases

    - name: Add new alias block to shell profiles
      blockinfile:
        path: "{{ item }}"
        block: "{{ lookup('template', 'shell_aliases.j2') }}"
        marker: ""
        insertafter: EOF
      loop: "{{ shell_profiles }}"
      tags: shell_aliases
